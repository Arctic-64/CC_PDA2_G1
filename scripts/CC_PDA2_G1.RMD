library
```{r}
library(shiny)
library(shinydashboard)
library(tidyverse)
library(ggplot2)
library(here)
library(lubridate)
library(sf)
library(leaflet)
library(leaflet.extras)
library(rgdal)

```

data loading
```{r}
raw_data <- read_csv(here("data/beds_by_nhs_board_of_treatment_and_specialty.csv"))

scotlandpoly <- readOGR("../data/HB_WGS_84_EPSG4326/reprojected_hb.shp")

health_boards <- read_csv(here("data/HB_scotland.csv"))

hospitals <- read_csv(here("data/hospitals_scotland.csv")) %>%
filter(!is.na(XCoordinate | YCoordinate))
```

addition of geo data

```{r}
hosptials_data <- inner_join(raw_data, hospitals, by = "Location")
HB_data <- inner_join(raw_data, health_boards, by = c("Location" = "HB"))


hospitals_longlat <- hospitals %>%
st_as_sf(coords = c("XCoordinate", "YCoordinate"), crs = 27700) %>% st_transform(4326) %>%
st_coordinates() %>%
as_tibble()
hospitals <- cbind(hospitals, hospitals_longlat)
```

prototype geo plot
```{r}
leaflet() %>%
addTiles() %>%
addResetMapButton()%>%
  addPolygons(data = scotlandpoly, popup = ~HBName, group = "HB_regions", layerId = ~HBName) %>%
  addCircles(data = hospitals, lng = ~X, lat = ~Y, label = ~LocationName, group = "hospital_locations", color = "red")
```

shiny
```{r}
ui <- fluidPage(

    # Application title
    titlePanel("jacks experiment"),

        #output print
    verticalLayout(
        wellPanel(textOutput("region_selected")),

        # the map
        mainPanel(
           leafletOutput("scotlandHM"),
           plotOutput("plotteddata")
        )
    )
)



# Define server logic 
server <- function(input, output) {
  ##map bullshit
  output$scotlandHM <- renderLeaflet({
    leaflet() %>%
addTiles() %>%
addResetMapButton()%>%
  addPolygons(data = scotlandpoly, popup = ~HBName, group = "HB_regions", layerId = ~HBName) %>%
  addCircles(data = hospitals, lng = ~X, lat = ~Y, label = ~LocationName, group = "hospital_locations", color = "red")
    })
    ## trigger map bullshit
observeEvent(input$scotlandHM_shape_click, { 
    region_selected <- input$scotlandHM_shape_click
    p <- renderText(region_selected$id)
    output$region_selected <- p

 ##map data bullshit
 filtered_df <- reactive({
    HB_data %>%
      filter(HBName == p)
  })
  ##plotting bullshit
  output$plotteddata <- renderPlot({
    ggplot(filtered_df()) +
      aes(x = Quarter, y = TotalOccupiedBeds) +
      geom_col()
    
  })
    
  })}



# Run the application 
shinyApp(ui = ui, server = server)
```


```{r}
HB_data
```

